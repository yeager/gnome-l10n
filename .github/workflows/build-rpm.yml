name: Build .rpm
on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: dnf install -y rpm-build python3 python3-devel sed coreutils gettext
      - name: Build RPM
        run: |
          VER=$(python3 -c 'exec(open("src/gnome_l10n/__init__.py").read()); print(__version__)')
          PKG=gnome-l10n
          
          mkdir -p ~/rpmbuild/{SOURCES,SPECS,BUILD,RPMS,SRPMS}
          tar czf ~/rpmbuild/SOURCES/${PKG}-${VER}.tar.gz --transform="s,^,${PKG}-${VER}/," src/ po/ data/ *.desktop *.metainfo.xml 2>/dev/null || tar czf ~/rpmbuild/SOURCES/${PKG}-${VER}.tar.gz --transform="s,^,${PKG}-${VER}/," src/ po/
          
          SPEC=$(cat <<'SPEC_END'
          Name:           gnome-l10n
          Version:        VERSIONPLACEHOLDER
          Release:        1
          Summary:        Translation statistics viewer for GNOME
          License:        GPL-3.0-or-later
          URL:            https://github.com/yeager/gnome-l10n
          Source0:        gnome-l10n-VERSIONPLACEHOLDER.tar.gz
          BuildArch:      noarch
          Requires:       python3, python3-gobject, gtk4, libadwaita
          
          %description
          GNOME translation statistics viewer -
          browse module completion for GNOME releases.
          
          %prep
          %setup -q
          
          %install
          mkdir -p %{buildroot}/usr/lib/python3/dist-packages/gnome_l10n
          cp src/gnome_l10n/*.py %{buildroot}/usr/lib/python3/dist-packages/gnome_l10n/
          mkdir -p %{buildroot}/usr/bin
          echo '#!/usr/bin/env python3' > %{buildroot}/usr/bin/gnome-l10n
          echo 'from gnome_l10n.main import main' >> %{buildroot}/usr/bin/gnome-l10n
          echo 'main()' >> %{buildroot}/usr/bin/gnome-l10n
          chmod +x %{buildroot}/usr/bin/gnome-l10n
          
          mkdir -p %{buildroot}/usr/share/applications
          mkdir -p %{buildroot}/usr/share/metainfo
          mkdir -p %{buildroot}/usr/share/icons/hicolor/scalable/apps
          for f in data/*.desktop *.desktop; do
            [ -f "$f" ] && install -m 644 "$f" %{buildroot}/usr/share/applications/
          done
          for f in data/*.metainfo.xml *.metainfo.xml; do
            [ -f "$f" ] && install -m 644 "$f" %{buildroot}/usr/share/metainfo/
          done
          find data/icons -name "*.svg" -exec install -m 644 {} %{buildroot}/usr/share/icons/hicolor/scalable/apps/ \; 2>/dev/null || true
          for po in po/*.po; do
            [ -f "$po" ] || continue
            lang=$(basename "$po" .po)
            mkdir -p %{buildroot}/usr/share/locale/$lang/LC_MESSAGES
            msgfmt -o %{buildroot}/usr/share/locale/$lang/LC_MESSAGES/%{name}.mo "$po"
          done
          
          %files
          /usr/lib/python3/dist-packages/gnome_l10n/
          /usr/bin/gnome-l10n
          /usr/share/applications/
          /usr/share/metainfo/
          /usr/share/icons/
          /usr/share/locale/*/LC_MESSAGES/%{name}.mo
          SPEC_END
          )
          
          echo "$SPEC" | sed "s/VERSIONPLACEHOLDER/$VER/g; s/^          //" > ~/rpmbuild/SPECS/${PKG}.spec
          rpmbuild -bb ~/rpmbuild/SPECS/${PKG}.spec
          cp ~/rpmbuild/RPMS/noarch/*.rpm .
      - uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: '*.rpm'
